{% extends "base.html" %}

{% block title %}Add Claim - Proclaim{% endblock %}

{% block content %}
<div class="animate-fade-in max-w-5xl mx-auto">
  <!-- Wizard Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Submit New Claim</h1>
    <p class="mt-2 text-sm text-gray-600">Follow the steps below to submit your insurance claim</p>
  </div>

  <!-- Progress Steps -->
  <div class="mb-8">
    <div class="flex items-center justify-between relative">
      <!-- Progress Bar Background -->
      <div class="absolute top-5 left-0 right-0 h-1 bg-gray-200" style="z-index: 0;"></div>
      <div id="progress-bar" class="absolute top-5 left-0 h-1 bg-gradient-to-r from-purple-600 to-pink-600 transition-all duration-500" style="width: 0%; z-index: 0;"></div>
      
      <!-- Step 1 -->
      <div class="flex flex-col items-center relative" style="z-index: 1;">
        <div id="step-1-circle" class="w-10 h-10 flex items-center justify-center bg-purple-600 text-white font-bold shadow-lg transition-all duration-300">
          <span id="step-1-number">1</span>
          <i id="step-1-check" class="fas fa-check hidden"></i>
        </div>
        <span class="mt-2 text-sm font-medium text-gray-900">Basic Details</span>
      </div>

      <!-- Step 2 -->
      <div class="flex flex-col items-center relative" style="z-index: 1;">
        <div id="step-2-circle" class="w-10 h-10 flex items-center justify-center bg-gray-300 text-gray-600 font-bold shadow-lg transition-all duration-300">
          <span id="step-2-number">2</span>
          <i id="step-2-check" class="fas fa-check hidden"></i>
        </div>
        <span class="mt-2 text-sm font-medium text-gray-500">Upload Images</span>
      </div>

      <!-- Step 3 -->
      <div class="flex flex-col items-center relative" style="z-index: 1;">
        <div id="step-3-circle" class="w-10 h-10 flex items-center justify-center bg-gray-300 text-gray-600 font-bold shadow-lg transition-all duration-300">
          <span id="step-3-number">3</span>
          <i id="step-3-check" class="fas fa-check hidden"></i>
        </div>
        <span class="mt-2 text-sm font-medium text-gray-500">Property Details</span>
      </div>

      <!-- Step 4 -->
      <div class="flex flex-col items-center relative" style="z-index: 1;">
        <div id="step-4-circle" class="w-10 h-10 flex items-center justify-center bg-gray-300 text-gray-600 font-bold shadow-lg transition-all duration-300">
          <span id="step-4-number">4</span>
          <i id="step-4-check" class="fas fa-check hidden"></i>
        </div>
        <span class="mt-2 text-sm font-medium text-gray-500">Analyze</span>
      </div>

      <!-- Step 5 -->
      <div class="flex flex-col items-center relative" style="z-index: 1;">
        <div id="step-5-circle" class="w-10 h-10 flex items-center justify-center bg-gray-300 text-gray-600 font-bold shadow-lg transition-all duration-300">
          <span id="step-5-number">5</span>
          <i id="step-5-check" class="fas fa-check hidden"></i>
        </div>
        <span class="mt-2 text-sm font-medium text-gray-500">Review & Submit</span>
      </div>
    </div>
  </div>

  <!-- Wizard Content Card -->
  <div class="bg-white shadow-xl overflow-hidden">
    <!-- Step 1: Basic Details -->
    <div id="step-1-content" class="wizard-step">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="fas fa-info-circle mr-3"></i>
          Step 1: Basic Claim Details
        </h2>
      </div>
      
      <div class="p-8">
        <form id="basic-details-form" class="space-y-6">
          <!-- Hidden User ID -->
          <input type="hidden" id="user_id" name="user_id">

          <!-- Insurance Company -->
          <div>
            <label for="insurance_code" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-building text-purple-600 mr-2"></i>
              Insurance Code
            </label>
            <select
              id="insurance_code"
              name="insurance_code"
              class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
            >
              <option value="">Select insurance code</option>
            </select>
          </div>

          <!-- Policy Number -->
          <div>
            <label for="policy_number" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-file-contract text-purple-600 mr-2"></i>
              Policy Number
            </label>
            <select
              id="policy_number"
              name="policy_number"
              disabled
              class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150 disabled:bg-gray-100"
            >
              <option value="">Select Policy Number</option>
            </select>
          </div>

          <!-- Insurance Claims Code -->
          <div>
            <label for="claims_code" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-barcode text-purple-600 mr-2"></i>
              Insurance Claims Code
            </label>
            <input
              type="text"
              id="claims_code"
              name="claims_code"
              placeholder="Enter claims code"
              class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
            />
          </div>

          <!-- Claims Details -->
          <div>
            <label for="claim_details" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-clipboard-list text-purple-600 mr-2"></i>
              Claims Details
            </label>
            <input
              type="text"
              id="claim_details"
              name="claim_details"
              placeholder="Describe claim details"
              class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
            />
          </div>

          <!-- Time of Loss -->
          <div>
            <label for="time_of_loss" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-clock text-purple-600 mr-2"></i>
              Time Of Loss
            </label>
            <input
              type="datetime-local"
              id="time_of_loss"
              name="time_of_loss"
              class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
            />
          </div>

          <!-- Location of Loss -->
          <div>
            <label for="situation_of_loss" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-map-marker-alt text-purple-600 mr-2"></i>
              Location of Loss Occurred
            </label>
            <input
              type="text"
              id="situation_of_loss"
              name="situation_of_loss"
              placeholder="Describe situation"
              class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
            />
          </div>

          <!-- Cause of Loss -->
          <div>
            <label for="cause_of_loss" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-exclamation-triangle text-purple-600 mr-2"></i>
              Cause of Loss Occurred
            </label>
            <input
              type="text"
              id="cause_of_loss"
              name="cause_of_loss"
              placeholder="Describe cause"
              class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
            />
          </div>
        </form>

        <!-- Navigation Buttons -->
        <div class="flex justify-end mt-8 pt-6 border-t border-gray-200">
          <button
            type="button"
            onclick="nextStep()"
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 shadow-lg"
          >
            Next: Upload Images
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Upload Images -->
    <div id="step-2-content" class="wizard-step hidden">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="fas fa-images mr-3"></i>
          Step 2: Upload Damage Images
        </h2>
      </div>
      
      <div class="p-8">
        <div class="mb-6">
          <p class="text-sm text-gray-600">
            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
            Upload clear images of the damaged property. Multiple images help with better assessment.
          </p>
        </div>

        <!-- Drag and Drop Zone -->
        <div
          id="drop-zone"
          class="border-3 border-dashed border-gray-300 bg-gray-50 hover:border-purple-500 hover:bg-purple-50 transition-all duration-300 p-12 text-center cursor-pointer"
        >
          <div class="space-y-4">
            <div class="flex justify-center">
              <i class="fas fa-cloud-upload-alt text-6xl text-gray-400"></i>
            </div>
            <div>
              <p class="text-lg font-semibold text-gray-700">Drag and drop images here</p>
              <p class="text-sm text-gray-500 mt-1">or click to browse</p>
            </div>
            <div>
              <span class="inline-block px-4 py-2 bg-purple-600 text-white text-sm font-medium hover:bg-purple-700 transition">
                Select Files
              </span>
            </div>
            <p class="text-xs text-gray-400">Supported formats: JPG, PNG, GIF (Max 10MB each)</p>
          </div>
          <input type="file" id="file-input" multiple accept="image/*" class="hidden" />
        </div>

        <!-- Upload Summary -->
        <div id="upload-summary" class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-4 hidden">
          <div class="flex items-center">
            <i class="fas fa-info-circle text-blue-600 mr-3"></i>
            <div>
              <p class="text-sm font-semibold text-blue-800">
                <span id="uploading-count">0</span> file(s) uploading...
              </p>
              <p class="text-xs text-blue-700 mt-1">Please wait while we process your images</p>
            </div>
          </div>
        </div>

        <!-- File List -->
        <div id="file-list" class="mt-6 space-y-3 hidden">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-700">
              <i class="fas fa-images mr-2"></i>
              Uploaded Images (<span id="file-count">0</span>)
            </h3>
            <button
              type="button"
              onclick="clearAllFiles()"
              class="text-sm text-red-600 hover:text-red-800 font-medium"
            >
              <i class="fas fa-trash mr-1"></i>
              Clear All
            </button>
          </div>
          <div id="file-items" class="space-y-3"></div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8 pt-6 border-t border-gray-200">
          <button
            type="button"
            onclick="previousStep()"
            class="inline-flex items-center px-6 py-3 bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            Previous
          </button>
          <button
            type="button"
            onclick="nextStep()"
            id="upload-next-btn"
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next: Property Details
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Damage Property Details -->
    <div id="step-3-content" class="wizard-step hidden">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="fas fa-home mr-3"></i>
          Step 3: Damaged Property Details
        </h2>
      </div>
      
      <div class="p-8">
        <div class="mb-6">
          <p class="text-sm text-gray-600">
            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
            Provide detailed information about the damaged property for accurate assessment.
          </p>
        </div>

        <form id="property-details-form" class="space-y-6">
          <!-- Claims Code (Read-only) -->
          <div>
            <label for="claims_code_display" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-barcode text-purple-600 mr-2"></i>
              Claims Code
            </label>
            <input
              type="text"
              id="claims_code_display"
              readonly
              class="w-full px-4 py-3 border border-gray-300 bg-gray-50 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
              placeholder="Claims code will appear here"
            />
          </div>

          <!-- Property Type and Wall Type Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Property Type -->
            <div>
              <label for="property_type" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-building text-purple-600 mr-2"></i>
                Property Type
              </label>
              <select
                id="property_type"
                name="property_type"
                required
                class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
              >
                <option value="">Select property type</option>
                <option value="building">Building</option>
                <option value="office">Office</option>
              </select>
            </div>

            <!-- Wall Type -->
            <div>
              <label for="wall_type" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-th-large text-purple-600 mr-2"></i>
                Wall Type
              </label>
              <select
                id="wall_type"
                name="wall_type"
                required
                class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
              >
                <option value="">Select wall type</option>
                <option value="brick_wall">Brick Wall</option>
                <option value="concrete_Wall">Concrete Wall</option>
                <option value="wood_wall">Wood Wall</option>
              </select>
            </div>
          </div>

          <!-- Damaged Area and Rate Per SqFt Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Damaged Area -->
            <div>
              <label for="damage_area" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-ruler-combined text-purple-600 mr-2"></i>
                Damaged Area (in SqFt)
              </label>
              <input
                type="number"
                id="damage_area"
                name="damage_area"
                placeholder="Enter damaged area"
                min="0"
                step="any"
                required
                class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
              />
            </div>

            <!-- Rate Per SqFt -->
            <div>
              <label for="rate_per_sqft" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-dollar-sign text-purple-600 mr-2"></i>
                Rate Per SqFt
              </label>
              <input
                type="number"
                id="rate_per_sqft"
                name="rate_per_sqft"
                placeholder="Enter rate per square foot"
                min="0"
                step="any"
                required
                value="350"
                class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150"
              />
            </div>
          </div>

          <!-- Hidden Fields (for future use) -->
          <input type="hidden" id="damage_length" name="damage_length" value="0" />
          <input type="hidden" id="damage_breadth" name="damage_breadth" value="0" />
          <input type="hidden" id="damage_height" name="damage_height" value="1" />
        </form>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8 pt-6 border-t border-gray-200">
          <button
            type="button"
            onclick="previousStep()"
            class="inline-flex items-center px-6 py-3 bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            Previous
          </button>
          <button
            type="button"
            onclick="nextStep()"
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 shadow-lg"
          >
            Next: Analyze
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 4: Analyze -->
    <div id="step-4-content" class="wizard-step hidden">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="fas fa-brain mr-3"></i>
          Step 4: AI Analysis
        </h2>
      </div>
      
      <div class="p-8">
        <div class="mb-6">
          <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
            <div class="flex items-start">
              <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
              <div>
                <h3 class="text-sm font-semibold text-blue-800">AI-Powered Damage Analysis</h3>
                <p class="text-sm text-blue-700 mt-1">
                  Our AI system will analyze the uploaded images to detect cracks, structural damage, and assess the severity.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-900">
            <i class="fas fa-images mr-2"></i>
            Uploaded Images (<span id="analysis-image-count">0</span>)
          </h3>
          <button
            type="button"
            id="analyze-all-btn"
            onclick="analyzeAllImages()"
            class="inline-flex items-center px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 shadow-lg"
          >
            <i class="fas fa-play mr-2"></i>
            Analyze All Images
          </button>
        </div>

        <!-- Images Analysis Table -->
        <div class="bg-white border border-gray-200 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Preview
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Image Name
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Size
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Status
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Action
                  </th>
                </tr>
              </thead>
              <tbody id="analysis-table-body" class="bg-white divide-y divide-gray-200">
                <!-- Table rows will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Empty State -->
        <div id="analysis-empty-state" class="hidden text-center py-12 bg-gray-50 border border-gray-200 mt-4">
          <i class="fas fa-images text-6xl text-gray-300 mb-4"></i>
          <h3 class="text-lg font-semibold text-gray-600 mb-2">No Images Uploaded</h3>
          <p class="text-sm text-gray-500">Please go back to Step 2 and upload images to analyze.</p>
        </div>

        <!-- Analysis Summary -->
        <div id="analysis-summary" class="mt-6 hidden">
          <div class="bg-green-50 border-l-4 border-green-500 p-4">
            <div class="flex items-start">
              <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
              <div class="flex-1">
                <h3 class="text-sm font-semibold text-green-800">All Images Analyzed!</h3>
                <p class="text-sm text-green-700 mt-1">
                  All <span id="summary-total-images">0</span> images have been analyzed successfully.
                </p>
              </div>
            </div>
          </div>

          <!-- Results Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
            <div class="bg-white border-2 border-purple-200 p-6 text-center">
              <i class="fas fa-images text-3xl text-purple-600 mb-3"></i>
              <div class="text-3xl font-bold text-gray-900" id="result-images-analyzed">0</div>
              <div class="text-sm text-gray-600 mt-1">Images Analyzed</div>
            </div>
            <div class="bg-white border-2 border-orange-200 p-6 text-center">
              <i class="fas fa-exclamation-triangle text-3xl text-orange-600 mb-3"></i>
              <div class="text-3xl font-bold text-gray-900" id="result-damages-detected">0</div>
              <div class="text-sm text-gray-600 mt-1">Damages Detected</div>
            </div>
            <div class="bg-white border-2 border-blue-200 p-6 text-center">
              <i class="fas fa-percentage text-3xl text-blue-600 mb-3"></i>
              <div class="text-3xl font-bold text-gray-900" id="result-confidence">0%</div>
              <div class="text-sm text-gray-600 mt-1">Avg Confidence</div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8 pt-6 border-t border-gray-200">
          <button
            type="button"
            onclick="previousStep()"
            class="inline-flex items-center px-6 py-3 bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            Previous
          </button>
          <button
            type="button"
            onclick="nextStep()"
            id="analyze-next-btn"
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next: Review & Submit
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 5: Review & Submit -->
    <div id="step-5-content" class="wizard-step hidden">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="fas fa-clipboard-check mr-3"></i>
          Step 5: Review & Submit
        </h2>
      </div>
      
      <div class="p-8">
        <div class="mb-6">
          <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
            <div class="flex items-start">
              <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
              <div>
                <h3 class="text-sm font-semibold text-blue-800">Processing Your Claim</h3>
                <p class="text-sm text-blue-700 mt-1">
                  Your images will be analyzed using AI to detect damage. This may take a few moments.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Review Details -->
        <div class="space-y-6 mb-8">
          <div class="bg-gray-50 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
              <i class="fas fa-file-alt mr-2"></i>
              Claim Summary
            </h3>
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Insurance Code</dt>
                <dd id="review-insurance" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Policy Number</dt>
                <dd id="review-policy" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Insurance Claims Code</dt>
                <dd id="review-claims-code" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Time of Loss</dt>
                <dd id="review-time-of-loss" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div class="md:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Claims Details</dt>
                <dd id="review-claim-details" class="mt-1 text-sm text-gray-900">-</dd>
              </div>
              <div class="md:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Location of Loss Occurred</dt>
                <dd id="review-situation-of-loss" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div class="md:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Cause of Loss Occurred</dt>
                <dd id="review-cause-of-loss" class="mt-1 text-sm text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Images Uploaded</dt>
                <dd id="review-image-count" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
            </dl>
          </div>

          <!-- Property Details Summary -->
          <div class="bg-gray-50 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
              <i class="fas fa-home mr-2"></i>
              Damaged Property Details
            </h3>
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Property Type</dt>
                <dd id="review-property-type" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Wall Type</dt>
                <dd id="review-year-built" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Damaged Area</dt>
                <dd id="review-property-area" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Rate Per SqFt</dt>
                <dd id="review-damage-severity" class="mt-1 text-sm font-semibold text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Damaged Length</dt>
                <dd id="review-affected-areas" class="mt-1 text-sm text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Damaged Breadth</dt>
                <dd id="review-property-notes" class="mt-1 text-sm text-gray-900">-</dd>
              </div>
            </dl>
          </div>

          <!-- Image Preview -->
          <div id="image-preview-section" class="bg-gray-50 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
              <i class="fas fa-images mr-2"></i>
              Uploaded Images
            </h3>
            <div id="image-preview-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <!-- Images will be added here -->
            </div>
          </div>
        </div>

        <!-- Processing Status -->
        <div id="processing-status" class="hidden mb-6">
          <div class="bg-purple-50 border border-purple-200 p-6 text-center">
            <div class="inline-block animate-spin h-10 w-10 border-b-2 border-purple-600 mb-4"></div>
            <p class="text-sm font-semibold text-purple-900">Processing your claim...</p>
            <p class="text-xs text-purple-700 mt-2">Analyzing images and creating claim report</p>
          </div>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="hidden mb-6">
          <div class="bg-green-50 border-l-4 border-green-500 p-4">
            <div class="flex items-start">
              <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
              <div>
                <h3 class="text-sm font-semibold text-green-800">Claim Submitted Successfully!</h3>
                <p class="text-sm text-green-700 mt-1">
                  Your claim has been created and is ready for review.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between pt-6 border-t border-gray-200">
          <button
            type="button"
            onclick="previousStep()"
            id="review-back-btn"
            class="inline-flex items-center px-6 py-3 bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            Previous
          </button>
          <div class="space-x-3">
            <button
              type="button"
              onclick="submitClaim()"
              id="submit-btn"
              class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white font-bold hover:from-green-700 hover:to-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 shadow-lg"
            >
              <i class="fas fa-paper-plane mr-2"></i>
              Submit Claim
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/auth_check.js') }}"></script>

<script>
let currentStep = 1;
let claimData = {
  user_id: '',
  insurance_code: '',
  policy_number: '',
  claims_code: '',
  claim_details: '',
  time_of_loss: '',
  situation_of_loss: '',
  cause_of_loss: '',
  images: [],
  property_type: '',
  wall_type: '',
  damage_area: '',
  damage_length: '0',
  damage_breadth: '0',
  damage_height: '1',
  rate_per_sqft: '350',
  analysis_completed: false,
  analysis_results: [] // Store AI analysis results
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadInsurancePolicies();
  setupFileUpload();
  updateFileCount();
});

// Load insurance policies
async function loadInsurancePolicies() {
  const token = localStorage.getItem('token');
  try {
    const response = await fetch('/api/insurance_claims_detail', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await response.json();
    
    // Set user ID
    const userIdInput = document.getElementById('user_id');
    userIdInput.value = data.user_id;
    claimData.user_id = data.user_id;
    
    // Populate insurance code dropdown
    const insuranceCodeSelect = document.getElementById('insurance_code');
    insuranceCodeSelect.innerHTML = '<option value="">Select insurance code</option>';
    
    data.insurance_codes.forEach(item => {
      const option = document.createElement('option');
      option.value = item.insurance_code;
      option.textContent = item.insurance_code;
      insuranceCodeSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Failed to fetch insurance claims detail:', error);
  }
}

// Load policy numbers when insurance is selected
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('insurance_code').addEventListener('change', async function() {
    const selectedCode = this.value;
    const policyNumberSelect = document.getElementById('policy_number');
    
    policyNumberSelect.innerHTML = '<option value="">Select Policy Number</option>';
    policyNumberSelect.disabled = true;
    
    if (!selectedCode) {
      return;
    }
    
    try {
      const response = await fetch('/api/get_policy?insurance_code=' + encodeURIComponent(selectedCode));
      const data = await response.json();
      
      data.policy_number_all.forEach(policyNumber => {
        const option = document.createElement('option');
        option.value = policyNumber;
        option.textContent = policyNumber;
        policyNumberSelect.appendChild(option);
      });
      policyNumberSelect.disabled = false;
    } catch (error) {
      console.error('Failed to fetch policy numbers:', error);
    }
  });
});

// Setup file upload
function setupFileUpload() {
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');
  
  dropZone.addEventListener('click', () => fileInput.click());
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-purple-500', 'bg-purple-50');
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-purple-500', 'bg-purple-50');
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-purple-500', 'bg-purple-50');
    handleFiles(e.dataTransfer.files);
  });
  
  fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });
}

let uploadingCount = 0;

// Handle uploaded files
function handleFiles(files) {
  const newFiles = Array.from(files);
  const fileList = document.getElementById('file-list');
  const uploadSummary = document.getElementById('upload-summary');
  const uploadingCountEl = document.getElementById('uploading-count');
  
  fileList.classList.remove('hidden');
  uploadSummary.classList.remove('hidden');
  
  uploadingCount += newFiles.length;
  uploadingCountEl.textContent = uploadingCount;
  
  // Process each file with upload simulation
  newFiles.forEach((file, index) => {
    simulateFileUpload(file);
  });
}

// Simulate file upload with progress
function simulateFileUpload(file) {
  const fileItems = document.getElementById('file-items');
  const fileId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  
  // Create file item with progress bar
  const div = document.createElement('div');
  div.id = fileId;
  div.className = 'bg-white border border-gray-200 p-4 transition-all duration-300';
  
  // Create thumbnail placeholder
  const reader = new FileReader();
  reader.onload = (e) => {
    const thumbnail = div.querySelector('.file-thumbnail');
    if (thumbnail) {
      thumbnail.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="${file.name}">`;
    }
  };
  reader.readAsDataURL(file);
  
  div.innerHTML = `
    <div class="flex items-start space-x-4">
      <!-- Thumbnail -->
      <div class="flex-shrink-0 w-16 h-16 bg-gray-100 file-thumbnail overflow-hidden">
        <div class="w-full h-full flex items-center justify-center">
          <i class="fas fa-image text-gray-400 text-2xl"></i>
        </div>
      </div>
      
      <!-- File Info -->
      <div class="flex-1 min-w-0">
        <div class="flex items-start justify-between">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-gray-900 truncate">${file.name}</p>
            <p class="text-xs text-gray-500 mt-1">
              ${(file.size / 1024 / 1024).toFixed(2)} MB
              <span class="mx-1">â€¢</span>
              <span class="upload-status text-blue-600">Uploading...</span>
            </p>
          </div>
          <button
            type="button"
            onclick="removeFileById('${fileId}')"
            class="ml-3 text-red-600 hover:text-red-800 transition duration-150"
            title="Remove"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <!-- Progress Bar -->
        <div class="mt-3">
          <div class="w-full bg-gray-200 h-2 overflow-hidden">
            <div class="progress-bar h-full bg-gradient-to-r from-purple-600 to-pink-600 transition-all duration-300" style="width: 0%"></div>
          </div>
          <div class="flex items-center justify-between mt-1">
            <span class="text-xs text-gray-500 progress-text">0%</span>
            <span class="text-xs text-green-600 success-check hidden">
              <i class="fas fa-check-circle mr-1"></i>
              Complete
            </span>
          </div>
        </div>
      </div>
    </div>
  `;
  
  fileItems.appendChild(div);
  
  // Simulate upload progress
  let progress = 0;
  const progressBar = div.querySelector('.progress-bar');
  const progressText = div.querySelector('.progress-text');
  const uploadStatus = div.querySelector('.upload-status');
  const successCheck = div.querySelector('.success-check');
  
  const interval = setInterval(() => {
    progress += Math.random() * 15;
    if (progress >= 100) {
      progress = 100;
      clearInterval(interval);
      
      // Show success state
      progressBar.style.width = '100%';
      progressText.textContent = '100%';
      uploadStatus.textContent = 'Uploaded';
      uploadStatus.classList.remove('text-blue-600');
      uploadStatus.classList.add('text-green-600');
      successCheck.classList.remove('hidden');
      progressText.classList.add('hidden');
      
      // Add to uploaded files array
      claimData.images.push(file);
      updateFileCount();
      
      // Decrease uploading count
      uploadingCount--;
      document.getElementById('uploading-count').textContent = uploadingCount;
      
      // Hide upload summary if all done
      if (uploadingCount === 0) {
        setTimeout(() => {
          document.getElementById('upload-summary').classList.add('hidden');
        }, 500);
      }
      
      // Add success animation
      div.classList.add('border-green-500', 'bg-green-50');
      setTimeout(() => {
        div.classList.remove('bg-green-50');
      }, 1000);
    } else {
      progressBar.style.width = progress + '%';
      progressText.textContent = Math.round(progress) + '%';
    }
  }, 150);
}

// Update file count
function updateFileCount() {
  const fileCount = document.getElementById('file-count');
  fileCount.textContent = claimData.images.length;
}

// Display files (legacy - now using simulateFileUpload)
function displayFiles() {
  updateFileCount();
  const fileList = document.getElementById('file-list');
  
  if (claimData.images.length === 0) {
    fileList.classList.add('hidden');
  } else {
    fileList.classList.remove('hidden');
  }
}

// Remove file by ID
function removeFileById(fileId) {
  const fileElement = document.getElementById(fileId);
  if (fileElement) {
    // Find the file in the array by name
    const fileName = fileElement.querySelector('.text-sm.font-semibold').textContent;
    const fileIndex = claimData.images.findIndex(f => f.name === fileName);
    
    if (fileIndex !== -1) {
      claimData.images.splice(fileIndex, 1);
    }
    
    // Remove from DOM with animation
    fileElement.style.opacity = '0';
    fileElement.style.transform = 'translateX(-20px)';
    setTimeout(() => {
      fileElement.remove();
      updateFileCount();
      
      // Hide list if no files
      if (claimData.images.length === 0) {
        document.getElementById('file-list').classList.add('hidden');
      }
    }, 300);
  }
}

// Remove file (legacy)
function removeFile(index) {
  claimData.images.splice(index, 1);
  displayFiles();
}

// Clear all files
function clearAllFiles() {
  if (confirm('Are you sure you want to remove all images?')) {
    claimData.images = [];
    document.getElementById('file-items').innerHTML = '';
    document.getElementById('file-list').classList.add('hidden');
    updateFileCount();
  }
}

// Update progress bar
function updateProgress() {
  const progressBar = document.getElementById('progress-bar');
  const width = ((currentStep - 1) / 4) * 100;
  progressBar.style.width = width + '%';
}

// Update step circles
function updateStepCircles() {
  for (let i = 1; i <= 5; i++) {
    const circle = document.getElementById(`step-${i}-circle`);
    const number = document.getElementById(`step-${i}-number`);
    const check = document.getElementById(`step-${i}-check`);
    
    if (i < currentStep) {
      circle.className = 'w-10 h-10 flex items-center justify-center bg-green-600 text-white font-bold shadow-lg transition-all duration-300';
      number.classList.add('hidden');
      check.classList.remove('hidden');
    } else if (i === currentStep) {
      circle.className = 'w-10 h-10 flex items-center justify-center bg-purple-600 text-white font-bold shadow-lg transition-all duration-300';
      number.classList.remove('hidden');
      check.classList.add('hidden');
    } else {
      circle.className = 'w-10 h-10 flex items-center justify-center bg-gray-300 text-gray-600 font-bold shadow-lg transition-all duration-300';
      number.classList.remove('hidden');
      check.classList.add('hidden');
    }
  }
  
  updateProgress();
}

// Next step
async function nextStep() {
  if (currentStep === 1) {
    // Save data (validation bypassed)
    claimData.user_id = document.getElementById('user_id').value;
    claimData.insurance_code = document.getElementById('insurance_code').value;
    claimData.policy_number = document.getElementById('policy_number').value;
    claimData.claims_code = document.getElementById('claims_code').value;
    claimData.claim_details = document.getElementById('claim_details').value;
    claimData.time_of_loss = document.getElementById('time_of_loss').value;
    claimData.situation_of_loss = document.getElementById('situation_of_loss').value;
    claimData.cause_of_loss = document.getElementById('cause_of_loss').value;
    
    // Skip API call if essential fields are missing
    if (claimData.insurance_code && claimData.policy_number && claimData.claims_code) {
      try {
        await createClaim();
      } catch (error) {
        console.error('Error creating claim, but continuing anyway:', error);
      }
    } else {
      console.log('Skipping API call - essential fields missing');
    }
  } else if (currentStep === 2) {
    // TEMPORARY: Allow proceeding even without images for design review
    // TODO: Uncomment this validation when ready for production
    // if (claimData.images.length === 0) {
    //   alert('Please upload at least one image.');
    //   return;
    // }
  } else if (currentStep === 3) {
    // Save property details
    claimData.property_type = document.getElementById('property_type').value;
    claimData.wall_type = document.getElementById('wall_type').value;
    claimData.damage_area = document.getElementById('damage_area').value;
    claimData.damage_length = document.getElementById('damage_length').value;
    claimData.damage_breadth = document.getElementById('damage_breadth').value;
    claimData.damage_height = document.getElementById('damage_height').value;
    claimData.rate_per_sqft = document.getElementById('rate_per_sqft').value;
  } else if (currentStep === 4) {
    // TEMPORARY: Allow proceeding without analysis for design review
    // TODO: Uncomment this validation when ready for production
    // if (!claimData.analysis_completed) {
    //   alert('Please complete the AI analysis before proceeding.');
    //   return;
    // }
    // Populate review
    populateReview();
  }
  
  currentStep++;
  showStep(currentStep);
}

// Previous step
function previousStep() {
  currentStep--;
  showStep(currentStep);
}

// Show step
function showStep(step) {
  document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
  document.getElementById(`step-${step}-content`).classList.remove('hidden');
  updateStepCircles();
  
  // Populate claims code when entering step 3
  if (step === 3) {
    const claimsCodeDisplay = document.getElementById('claims_code_display');
    if (claimsCodeDisplay && claimData.claims_code) {
      claimsCodeDisplay.value = claimData.claims_code;
    }
  }
  
  // Populate analysis table when entering step 4
  if (step === 4) {
    populateAnalysisTable();
  }
}

// Create claim
async function createClaim() {
  const token = localStorage.getItem('token');
  
  const formData = new FormData();
  formData.append('user_id', claimData.user_id);
  formData.append('insurance_code', claimData.insurance_code);
  formData.append('policy_number', claimData.policy_number);
  formData.append('claims_code', claimData.claims_code);
  formData.append('claim_details', claimData.claim_details);
  formData.append('time_of_loss', claimData.time_of_loss);
  formData.append('situation_of_loss', claimData.situation_of_loss);
  formData.append('cause_of_loss', claimData.cause_of_loss);
  
  try {
    const response = await fetch('/submit_insurance_claims', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      body: formData
    });
    
    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error || 'Failed to create claim');
    }
    
    // Success - claims_code already saved in claimData
    console.log('Claim created successfully:', data);
  } catch (error) {
    console.error('Error creating claim:', error);
    alert('Failed to create claim. Please try again.');
    throw error;
  }
}

// Populate review
function populateReview() {
  document.getElementById('review-insurance').textContent = claimData.insurance_code || 'Not specified';
  document.getElementById('review-policy').textContent = claimData.policy_number || 'Not specified';
  document.getElementById('review-claims-code').textContent = claimData.claims_code || 'Not specified';
  document.getElementById('review-claim-details').textContent = claimData.claim_details || 'Not specified';
  document.getElementById('review-time-of-loss').textContent = claimData.time_of_loss ? new Date(claimData.time_of_loss).toLocaleString() : 'Not specified';
  document.getElementById('review-situation-of-loss').textContent = claimData.situation_of_loss || 'Not specified';
  document.getElementById('review-cause-of-loss').textContent = claimData.cause_of_loss || 'Not specified';
  document.getElementById('review-image-count').textContent = `${claimData.images.length} image(s)`;
  
  // Populate property details
  document.getElementById('review-property-type').textContent = claimData.property_type || 'Not specified';
  document.getElementById('review-property-area').textContent = claimData.damage_area ? `${claimData.damage_area} sq ft` : 'Not specified';
  document.getElementById('review-year-built').textContent = claimData.wall_type || 'Not specified';
  document.getElementById('review-damage-severity').textContent = claimData.rate_per_sqft ? `$${claimData.rate_per_sqft}` : 'Not specified';
  document.getElementById('review-affected-areas').textContent = claimData.damage_length ? `${claimData.damage_length} ft` : 'Not specified';
  document.getElementById('review-property-notes').textContent = claimData.damage_breadth ? `${claimData.damage_breadth} ft` : 'Not specified';
  
  // Show image previews
  const grid = document.getElementById('image-preview-grid');
  grid.innerHTML = '';
  
  if (claimData.images.length === 0) {
    // Show placeholder if no images
    grid.innerHTML = '<div class="col-span-4 text-center py-8 text-gray-500"><i class="fas fa-images text-4xl mb-2"></i><p class="text-sm">No images uploaded</p></div>';
  } else {
    claimData.images.forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const div = document.createElement('div');
        div.className = 'aspect-square overflow-hidden bg-gray-100';
        div.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="Preview">`;
        grid.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  }
}

// Image analysis status tracking
let imageAnalysisStatus = [];
let imageAnalysisResults = [];

// Populate Analysis Table
function populateAnalysisTable() {
  const tableBody = document.getElementById('analysis-table-body');
  const imageCount = document.getElementById('analysis-image-count');
  const emptyState = document.getElementById('analysis-empty-state');
  const summary = document.getElementById('analysis-summary');
  const analyzeAllBtn = document.getElementById('analyze-all-btn');
  
  // Hide summary initially
  summary.classList.add('hidden');
  
  // Reset analyze all button
  analyzeAllBtn.disabled = false;
  analyzeAllBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Analyze All Images';
  analyzeAllBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
  analyzeAllBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
  
  // Update count
  imageCount.textContent = claimData.images.length;
  
  // Clear table
  tableBody.innerHTML = '';
  
  // Initialize status and results arrays
  imageAnalysisStatus = claimData.images.map(() => 'pending');
  imageAnalysisResults = claimData.images.map(() => null);
  
  if (claimData.images.length === 0) {
    emptyState.classList.remove('hidden');
    return;
  } else {
    emptyState.classList.add('hidden');
  }
  
  // Populate table rows
  claimData.images.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const row = document.createElement('tr');
      row.id = `analysis-row-${index}`;
      row.className = 'hover:bg-gray-50 transition duration-150';
      
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
          <div id="preview-${index}" class="w-16 h-16 bg-gray-100 overflow-hidden">
            <img src="${e.target.result}" class="w-full h-full object-cover" alt="${file.name}">
          </div>
        </td>
        <td class="px-6 py-4">
          <div class="text-sm font-medium text-gray-900 truncate max-w-xs">${file.name}</div>
          <div id="result-${index}" class="text-xs text-gray-500 mt-1 hidden"></div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm text-gray-600">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span id="status-${index}" class="inline-flex items-center px-3 py-1 text-xs font-medium bg-gray-100 text-gray-800">
            <i class="fas fa-circle text-gray-400 mr-2 text-xs"></i>
            Pending
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">
          <button
            id="analyze-btn-${index}"
            onclick="analyzeSingleImage(${index})"
            class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-xs font-medium hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150"
          >
            <i class="fas fa-play mr-2"></i>
            Analyze
          </button>
          <button
            id="view-btn-${index}"
            onclick="viewAnalyzedImage(${index})"
            class="hidden inline-flex items-center px-4 py-2 ml-2 bg-blue-600 text-white text-xs font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150"
          >
            <i class="fas fa-eye mr-2"></i>
            View
          </button>
        </td>
      `;
      
      tableBody.appendChild(row);
    };
    reader.readAsDataURL(file);
  });
}

// Analyze Single Image
async function analyzeSingleImage(index) {
  const statusBadge = document.getElementById(`status-${index}`);
  const analyzeBtn = document.getElementById(`analyze-btn-${index}`);
  const viewBtn = document.getElementById(`view-btn-${index}`);
  const resultDiv = document.getElementById(`result-${index}`);
  const file = claimData.images[index];
  
  // Update status to in progress
  imageAnalysisStatus[index] = 'in-progress';
  statusBadge.className = 'inline-flex items-center px-3 py-1 text-xs font-medium bg-blue-100 text-blue-800';
  statusBadge.innerHTML = `
    <i class="fas fa-circle-notch fa-spin text-blue-600 mr-2 text-xs"></i>
    Analyzing...
  `;
  analyzeBtn.disabled = true;
  analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
  
  try {
    // Prepare form data for API call
    const formData = new FormData();
    formData.append('image', file);
    
    // Call the crack detection API with visualization generation
    const response = await fetch('/api/detection/crack-with-visualization', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error('Analysis failed');
    }
    
    const result = await response.json();
    
    // Store the analysis result with processed image URL from backend
    imageAnalysisResults[index] = {
      file_name: file.name,
      predicted_class: result.predicted_class,
      confidence: result.confidence,
      probabilities: result.probabilities,
      crack_percent: result.probabilities['Positive (Crack Detected)'] || 0,
      non_crack_percent: result.probabilities['Negative (No Crack)'] || 0,
      original_file: file,
      processed_image_url: result.processed_image_url,  // URL to actual visualization generated by OpenCV
      crack_data: result.crack_data
    };
    
    // Update status to done
    imageAnalysisStatus[index] = 'done';
    statusBadge.className = 'inline-flex items-center px-3 py-1 text-xs font-medium bg-green-100 text-green-800';
    statusBadge.innerHTML = `
      <i class="fas fa-check-circle text-green-600 mr-2 text-xs"></i>
      Analyzed
    `;
    
    // Show result details
    const isCrackDetected = result.predicted_class.includes('Crack Detected');
    const resultClass = isCrackDetected ? 'text-orange-600' : 'text-green-600';
    resultDiv.className = `text-xs mt-1 ${resultClass} font-semibold`;
    resultDiv.textContent = `${result.predicted_class} (${result.confidence}%)`;
    resultDiv.classList.remove('hidden');
    
    // Update button
    analyzeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Analyzed';
    analyzeBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
    analyzeBtn.classList.add('bg-green-600', 'hover:bg-green-700');
    analyzeBtn.disabled = false;
    analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    
    // Show view button
    viewBtn.classList.remove('hidden');
    
    // Check if all images are analyzed
    updateAnalysisStatus();
    
  } catch (error) {
    console.error('Error analyzing image:', error);
    
    // Update status to error
    imageAnalysisStatus[index] = 'error';
    statusBadge.className = 'inline-flex items-center px-3 py-1 text-xs font-medium bg-red-100 text-red-800';
    statusBadge.innerHTML = `
      <i class="fas fa-exclamation-circle text-red-600 mr-2 text-xs"></i>
      Error
    `;
    
    resultDiv.className = 'text-xs mt-1 text-red-600';
    resultDiv.textContent = 'Analysis failed. Please try again.';
    resultDiv.classList.remove('hidden');
    
    // Re-enable button
    analyzeBtn.disabled = false;
    analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    
    alert('Failed to analyze image. Please try again.');
  }
}

// Analyze All Images
async function analyzeAllImages() {
  const analyzeAllBtn = document.getElementById('analyze-all-btn');
  analyzeAllBtn.disabled = true;
  analyzeAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
  
  // Analyze all pending images sequentially
  for (let i = 0; i < claimData.images.length; i++) {
    if (imageAnalysisStatus[i] === 'pending') {
      await analyzeSingleImage(i);
    }
  }
  
  analyzeAllBtn.innerHTML = '<i class="fas fa-check mr-2"></i>All Analyzed';
  analyzeAllBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
  analyzeAllBtn.classList.add('bg-green-600', 'hover:bg-green-700');
}

// Update Analysis Status
function updateAnalysisStatus() {
  const allDone = imageAnalysisStatus.every(status => status === 'done');
  const analyzedCount = imageAnalysisStatus.filter(status => status === 'done').length;
  
  if (allDone && claimData.images.length > 0) {
    // Calculate real statistics from analysis results
    const damagesDetected = imageAnalysisResults.filter(r => 
      r && r.predicted_class && r.predicted_class.includes('Crack Detected')
    ).length;
    
    const avgConfidence = imageAnalysisResults.reduce((sum, r) => 
      sum + (r ? r.confidence : 0), 0
    ) / imageAnalysisResults.length;
    
    // Show summary
    const summary = document.getElementById('analysis-summary');
    summary.classList.remove('hidden');
    
    document.getElementById('summary-total-images').textContent = claimData.images.length;
    document.getElementById('result-images-analyzed').textContent = claimData.images.length;
    document.getElementById('result-damages-detected').textContent = damagesDetected;
    document.getElementById('result-confidence').textContent = avgConfidence.toFixed(1) + '%';
    
    // Store analysis results in claimData
    claimData.analysis_results = imageAnalysisResults;
    
    // Mark analysis as completed
    claimData.analysis_completed = true;
    
    // Scroll to summary
    summary.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// View Analyzed Image
function viewAnalyzedImage(index) {
  const result = imageAnalysisResults[index];
  const file = claimData.images[index];
  
  if (!result) {
    alert('Analysis result not found. Please analyze the image first.');
    return;
  }
  
  // Create modal to show analysis details
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  modal.onclick = (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  };
  
  const isCrackDetected = result.predicted_class.includes('Crack Detected');
  const statusColor = isCrackDetected ? 'orange' : 'green';
  const statusIcon = isCrackDetected ? 'exclamation-triangle' : 'check-circle';
  
  // Read both original and processed images
  const reader = new FileReader();
  reader.onload = async (e) => {
    const originalImageSrc = e.target.result;
    
    // Get the processed image URL from backend (generated by OpenCV model)
    let processedImageSrc = result.processed_image_url || null;
    
    modal.innerHTML = `
      <div class="bg-white max-w-5xl w-full max-h-[90vh] overflow-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4 flex items-center justify-between">
          <h3 class="text-xl font-bold text-white flex items-center">
            <i class="fas fa-brain mr-3"></i>
            AI Crack Detection Analysis
          </h3>
          <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200">
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>
        
        <!-- Content -->
        <div class="p-6">
          <!-- File Info -->
          <div class="mb-6 bg-gray-50 p-4">
            <h4 class="font-semibold text-gray-900 mb-2">
              <i class="fas fa-file-image mr-2"></i>${file.name}
            </h4>
            <p class="text-sm text-gray-600">Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
          </div>
          
          <!-- AI Decision -->
          <div class="mb-6 bg-${statusColor}-50 border-l-4 border-${statusColor}-500 p-4">
            <div class="flex items-center">
              <i class="fas fa-${statusIcon} text-${statusColor}-600 text-3xl mr-4"></i>
              <div>
                <h4 class="text-lg font-bold text-${statusColor}-900">${result.predicted_class}</h4>
                <p class="text-sm text-${statusColor}-700 mt-1">Confidence: ${result.confidence}%</p>
              </div>
            </div>
          </div>
          
          <!-- Probability Details -->
          <div class="mb-6">
            <h4 class="font-semibold text-gray-900 mb-3">
              <i class="fas fa-chart-bar mr-2"></i>Detection Probabilities
            </h4>
            <div class="space-y-3">
              <div>
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium text-gray-700">Crack Detected</span>
                  <span class="text-sm font-bold text-orange-600">${result.crack_percent.toFixed(2)}%</span>
                </div>
                <div class="w-full bg-gray-200 h-3">
                  <div class="bg-gradient-to-r from-orange-500 to-red-500 h-3 transition-all duration-500" style="width: ${result.crack_percent}%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium text-gray-700">No Crack</span>
                  <span class="text-sm font-bold text-green-600">${result.non_crack_percent.toFixed(2)}%</span>
                </div>
                <div class="w-full bg-gray-200 h-3">
                  <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-3 transition-all duration-500" style="width: ${result.non_crack_percent}%"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Image Comparison Side by Side -->
          <div class="mb-6">
            <h4 class="font-semibold text-gray-900 mb-3">
              <i class="fas fa-images mr-2"></i>Image Analysis Comparison
            </h4>
            ${processedImageSrc ? `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Original Image -->
              <div>
                <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                  <i class="fas fa-image mr-2 text-blue-600"></i>Original Image
                </h5>
                <div class="bg-gray-100 p-2 border-2 border-gray-300">
                  <img src="${originalImageSrc}" class="w-full h-auto" alt="Original">
                </div>
              </div>
              
              <!-- Processed Image with Crack Detection -->
              <div>
                <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                  <i class="fas fa-microscope mr-2 text-purple-600"></i>Crack Detection Visualization
                </h5>
                <div class="bg-gray-100 p-2 border-2 border-purple-500">
                  <img src="${processedImageSrc}" class="w-full h-auto" alt="Processed with crack detection">
                </div>
                <p class="text-xs text-green-600 mt-2 flex items-start">
                  <i class="fas fa-check-circle mr-1 mt-0.5"></i>
                  <span>Showing actual crack visualization generated by AI model</span>
                </p>
              </div>
            </div>
            ` : `
            <div>
              <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                <i class="fas fa-image mr-2 text-blue-600"></i>Original Image
              </h5>
              <div class="bg-gray-100 p-2 border-2 border-gray-300">
                <img src="${originalImageSrc}" class="w-full h-auto" alt="Original">
              </div>
              <p class="text-xs text-gray-600 mt-2 flex items-start">
                <i class="fas fa-info-circle text-blue-500 mr-1 mt-0.5"></i>
                <span>Detailed crack visualization with contours will be generated during final submission. The visualization image will be saved to the database and viewable in reports.</span>
              </p>
            </div>
            `}
          </div>
          
          <!-- Action Buttons -->
          <div class="flex justify-end space-x-3">
            <button 
              onclick="this.closest('.fixed').remove()" 
              class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-150 shadow-lg"
            >
              <i class="fas fa-times mr-2"></i>Close
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  };
  reader.readAsDataURL(file);
}

// Submit claim
async function submitClaim() {
  const submitBtn = document.getElementById('submit-btn');
  const reviewBackBtn = document.getElementById('review-back-btn');
  const processingStatus = document.getElementById('processing-status');
  const successMessage = document.getElementById('success-message');
  
  // Disable buttons
  submitBtn.disabled = true;
  reviewBackBtn.disabled = true;
  processingStatus.classList.remove('hidden');
  
  try {
    const token = localStorage.getItem('token');
    
    // Upload images
    const formData = new FormData();
    formData.append('claims_code', claimData.claims_code);
    claimData.images.forEach(file => {
      formData.append('files', file);
    });
    
    const response = await fetch('/upload_damaged_property_image', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      body: formData
    });
    
    if (response.ok) {
      processingStatus.classList.add('hidden');
      successMessage.classList.remove('hidden');
      
      // Redirect after 2 seconds
      setTimeout(() => {
        window.location.href = `/new_report?claims_code=${claimData.claims_code}`;
      }, 2000);
    } else {
      throw new Error('Upload failed');
    }
  } catch (error) {
    console.error('Error submitting claim:', error);
    alert('Failed to submit claim. Please try again.');
    submitBtn.disabled = false;
    reviewBackBtn.disabled = false;
    processingStatus.classList.add('hidden');
  }
}

// Initialize on page load
showStep(1);
</script>

{% endblock %}

