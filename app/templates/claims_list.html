{% extends "base.html" %}

{% block title %}Claims - Proclaim{% endblock %}

{% block content %}
<div class="animate-fade-in">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Insurance Claims</h1>
        <p class="mt-2 text-sm text-gray-600">Track and manage all your insurance claims</p>
      </div>
      <div class="mt-4 md:mt-0">
        <a
          href="{{ url_for('insurance_pages.insurance_claims_detail') }}"
          class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-semibold text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 shadow-lg hover:shadow-xl transition duration-150 ease-in-out transform hover:-translate-y-0.5"
        >
          <i class="fas fa-plus mr-2"></i>
          Add Claim
        </a>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div id="stats-section" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 hidden">
    <div class="bg-white shadow-lg p-6 border-l-4 border-purple-500">
      <div class="flex items-center">
        <div class="flex-shrink-0 bg-purple-100 p-3">
          <i class="fas fa-file-medical-alt text-purple-600 text-2xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Total Claims</p>
          <p id="total-claims" class="text-2xl font-bold text-gray-900">0</p>
        </div>
      </div>
    </div>

    <div class="bg-white shadow-lg p-6 border-l-4 border-green-500">
      <div class="flex items-center">
        <div class="flex-shrink-0 bg-green-100 p-3">
          <i class="fas fa-check-circle text-green-600 text-2xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Approved</p>
          <p id="approved-claims" class="text-2xl font-bold text-gray-900">0</p>
        </div>
      </div>
    </div>

    <div class="bg-white shadow-lg p-6 border-l-4 border-amber-500">
      <div class="flex items-center">
        <div class="flex-shrink-0 bg-amber-100 p-3">
          <i class="fas fa-clock text-amber-600 text-2xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Pending</p>
          <p id="pending-claims" class="text-2xl font-bold text-gray-900">0</p>
        </div>
      </div>
    </div>

    <div class="bg-white shadow-lg p-6 border-l-4 border-blue-500">
      <div class="flex items-center">
        <div class="flex-shrink-0 bg-blue-100 p-3">
          <i class="fas fa-dollar-sign text-blue-600 text-2xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Total Value</p>
          <p id="total-value" class="text-2xl font-bold text-gray-900">$0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Claims Table Card -->
  <div class="bg-white shadow-xl overflow-hidden">
    <!-- Card Header -->
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="fas fa-list mr-3"></i>
          All Claims
        </h2>
        <span id="claim-count" class="bg-white/20 backdrop-blur-sm px-3 py-1 text-white font-semibold text-sm">
          0 Claims
        </span>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <div class="text-center">
        <div class="inline-block animate-spin h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
        <p class="text-gray-600 font-medium">Loading claims...</p>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 px-4">
      <div class="w-24 h-24 bg-gray-100 flex items-center justify-center mb-4">
        <i class="fas fa-file-medical-alt text-gray-400 text-4xl"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">No Claims Found</h3>
      <p class="text-sm text-gray-500 text-center max-w-sm mb-6">
        You haven't submitted any insurance claims yet. Click the button below to submit your first claim.
      </p>
      <a
        href="{{ url_for('insurance_pages.insurance_claims_detail') }}"
        class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 transition duration-150"
      >
        <i class="fas fa-plus mr-2"></i>
        Submit Your First Claim
      </a>
    </div>

    <!-- Table Container -->
    <div id="table-container" class="hidden overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Claim Details
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Policy Info
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Claimant
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Dates
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Claim Value
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody id="claims-table-body" class="bg-white divide-y divide-gray-200">
          <!-- Rows will be populated dynamically -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/auth_check.js') }}"></script>

<script>
let allClaims = [];

// Fetch claims
async function fetchClaims() {
  const token = localStorage.getItem('token');
  const loadingState = document.getElementById('loading-state');
  const emptyState = document.getElementById('empty-state');
  const tableContainer = document.getElementById('table-container');
  const statsSection = document.getElementById('stats-section');
  
  try {
    const response = await fetch('/api/insurance/claims/all', {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to fetch claims');
    }
    
    const data = await response.json();
    allClaims = data.claims || [];
    
    loadingState.classList.add('hidden');
    
    if (allClaims.length === 0) {
      emptyState.classList.remove('hidden');
      tableContainer.classList.add('hidden');
      statsSection.classList.add('hidden');
    } else {
      emptyState.classList.add('hidden');
      tableContainer.classList.remove('hidden');
      statsSection.classList.remove('hidden');
      renderClaims(allClaims);
      updateStats(allClaims);
    }
    
  } catch (error) {
    console.error('Error loading claims:', error);
    loadingState.classList.add('hidden');
    emptyState.classList.remove('hidden');
  }
}

// Render claims in table
function renderClaims(claims) {
  const tbody = document.getElementById('claims-table-body');
  tbody.innerHTML = '';
  
  claims.forEach((claim) => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50 transition duration-150';
    
    // Format dates
    const incidentDate = claim.incident_date ? new Date(claim.incident_date).toLocaleDateString() : 'N/A';
    const claimDate = claim.claim_date ? new Date(claim.claim_date).toLocaleDateString() : 'N/A';
    
    // Status badge with better mapping
    const statusColors = {
      'active': 'bg-green-100 text-green-800',
      'inactive': 'bg-amber-100 text-amber-800',
      'approved': 'bg-green-100 text-green-800',
      'pending': 'bg-amber-100 text-amber-800',
      'rejected': 'bg-red-100 text-red-800',
      'processing': 'bg-blue-100 text-blue-800',
      'completed': 'bg-green-100 text-green-800'
    };
    const statusClass = statusColors[claim.claim_status?.toLowerCase()] || 'bg-gray-100 text-gray-800';
    
    // Claim value formatting
    const claimValue = claim.total_claim_value && claim.total_claim_value > 0
      ? `$${parseFloat(claim.total_claim_value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
      : 'Pending';
    
    // Recommendation badge
    const recommendBadge = claim.claim_recommended === 'yes' 
      ? '<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i> Recommended</span>'
      : claim.claim_recommended === 'no'
      ? '<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-times-circle mr-1"></i> Not Recommended</span>'
      : '<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600"><i class="fas fa-hourglass-half mr-1"></i> In Review</span>';
    
    tr.innerHTML = `
      <td class="px-6 py-4">
        <div>
          <div class="text-sm font-medium text-gray-900">${claim.claims_code || 'N/A'}</div>
          <div class="text-sm text-gray-500 mt-1">${claim.description ? (claim.description.length > 50 ? claim.description.substring(0, 50) + '...' : claim.description) : 'No description'}</div>
        </div>
      </td>
      <td class="px-6 py-4">
        <div>
          <div class="text-sm font-medium text-gray-900">${claim.insurance_code || 'N/A'}</div>
          <div class="text-sm text-gray-500">Policy: ${claim.policy_number || 'N/A'}</div>
          ${claim.insurance_type ? `<span class="inline-flex items-center mt-1 px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 capitalize">${claim.insurance_type}</span>` : ''}
        </div>
      </td>
      <td class="px-6 py-4">
        <div class="text-sm font-medium text-gray-900">${claim.insured || 'N/A'}</div>
      </td>
      <td class="px-6 py-4">
        <div class="text-sm text-gray-900">
          <div title="Incident Date"><i class="fas fa-exclamation-triangle text-amber-500 mr-1"></i> ${incidentDate}</div>
          <div class="mt-1" title="Claim Filed"><i class="fas fa-calendar-alt text-gray-400 mr-1"></i> ${claimDate}</div>
        </div>
      </td>
      <td class="px-6 py-4">
        <div>
          <div class="text-sm font-bold text-gray-900">${claimValue}</div>
          <div class="mt-1">${recommendBadge}</div>
        </div>
      </td>
      <td class="px-6 py-4">
        <span class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium ${statusClass} capitalize">
          ${claim.claim_status || 'Inactive'}
        </span>
      </td>
      <td class="px-6 py-4 text-sm">
        <div class="flex space-x-3">
          <button
            onclick="viewClaim('${claim.claims_code}')"
            class="text-blue-600 hover:text-blue-900 transition duration-150"
            title="View Details"
          >
            <i class="fas fa-eye"></i>
          </button>
          <button
            onclick="editClaim(${claim.id})"
            class="text-green-600 hover:text-green-900 transition duration-150"
            title="Edit Claim"
          >
            <i class="fas fa-edit"></i>
          </button>
        </div>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
  
  updateClaimCount(claims.length);
}

// Update statistics
function updateStats(claims) {
  const total = claims.length;
  // Count active and completed as approved
  const approved = claims.filter(c => 
    c.claim_status?.toLowerCase() === 'approved' || 
    c.claim_status?.toLowerCase() === 'active' ||
    c.claim_status?.toLowerCase() === 'completed'
  ).length;
  // Count inactive and pending
  const pending = claims.filter(c => 
    c.claim_status?.toLowerCase() === 'pending' || 
    c.claim_status?.toLowerCase() === 'inactive' ||
    !c.claim_status
  ).length;
  const totalValue = claims.reduce((sum, c) => sum + (parseFloat(c.total_claim_value) || 0), 0);
  
  document.getElementById('total-claims').textContent = total;
  document.getElementById('approved-claims').textContent = approved;
  document.getElementById('pending-claims').textContent = pending;
  document.getElementById('total-value').textContent = `$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

// Update claim count
function updateClaimCount(count) {
  document.getElementById('claim-count').textContent = `${count} ${count === 1 ? 'Claim' : 'Claims'}`;
}

// View claim details
function viewClaim(claimsCode) {
  // Navigate to new report page with the claims code
  window.location.href = `/new_report?claims_code=${claimsCode}`;
}

// Edit claim
function editClaim(claimId) {
  // TODO: Implement edit functionality
  alert(`Edit claim ${claimId} - Feature coming soon!`);
}

// Initialize
fetchClaims();
</script>

{% endblock %}

