{% extends "base.html" %}

{% block title %}Submit Claim - Proclaim{% endblock %}

{% block content %}
<div class="animate-fade-in">
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Submit Insurance Claim</h1>
    <p class="mt-2 text-sm text-gray-600">File a new claim for earthquake damage assessment</p>
  </div>

  <!-- Form Card -->
  <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-5xl">
    <!-- Card Header -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 py-6">
      <h2 class="text-2xl font-bold text-white flex items-center">
        <i class="fas fa-file-medical-alt mr-3"></i>
        Insurance Claim Details
      </h2>
      <p class="mt-1 text-sm text-purple-100">Provide information about your damage claim</p>
    </div>

    <!-- Form Body -->
    <div class="p-8">
      <form id="insuranceClaimsForm" action="/submit_insurance_claims" method="POST" class="space-y-6">
        <input type="hidden" id="user_id" name="user_id" value="{{ user_id }}">
        
        <!-- Policy Selection Section -->
        <div class="space-y-6">
          <h3 class="text-lg font-semibold text-gray-900 border-b-2 border-purple-200 pb-2 flex items-center">
            <i class="fas fa-shield-check text-purple-600 mr-2"></i>
            Select Your Policy
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Insurance Code -->
            <div>
              <label for="insuranceCode" class="block text-sm font-medium text-gray-700 mb-2">
                Insurance Code <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-barcode text-gray-400"></i>
                </div>
                <select
                  id="insuranceCode"
                  name="insurance_id"
                  required
                  class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150 ease-in-out sm:text-sm"
                >
                  <option value="">Select insurance code</option>
                </select>
              </div>
            </div>

            <!-- Policy Number -->
            <div>
              <label for="policyNumber" class="block text-sm font-medium text-gray-700 mb-2">
                Policy Number <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-hashtag text-gray-400"></i>
                </div>
                <select
                  id="policyNumber"
                  name="policy_number"
                  required
                  class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150 ease-in-out sm:text-sm"
                >
                  <option value="">Select policy number</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Claim Information Section -->
        <div class="space-y-6">
          <h3 class="text-lg font-semibold text-gray-900 border-b-2 border-blue-200 pb-2 flex items-center">
            <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
            Claim Information
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Claims Code -->
            <div>
              <label for="insuranceClaimsCode" class="block text-sm font-medium text-gray-700 mb-2">
                Claim Code <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-ticket-alt text-gray-400"></i>
                </div>
                <input
                  type="text"
                  id="insuranceClaimsCode"
                  name="claims_code"
                  required
                  class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150 ease-in-out sm:text-sm"
                  placeholder="Enter claim code"
                />
              </div>
            </div>

            <!-- Time of Loss -->
            <div>
              <label for="timeOfLoss" class="block text-sm font-medium text-gray-700 mb-2">
                Date & Time of Loss <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-clock text-gray-400"></i>
                </div>
                <input
                  type="datetime-local"
                  id="timeOfLoss"
                  name="time_of_loss"
                  required
                  class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150 ease-in-out sm:text-sm"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Loss Details Section -->
        <div class="space-y-6">
          <h3 class="text-lg font-semibold text-gray-900 border-b-2 border-red-200 pb-2 flex items-center">
            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
            Loss Details
          </h3>
          
          <!-- Situation of Loss -->
          <div>
            <label for="situationOfLoss" class="block text-sm font-medium text-gray-700 mb-2">
              Situation of Loss <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <textarea
                id="situationOfLoss"
                name="situation_of_loss"
                rows="3"
                required
                class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150 ease-in-out sm:text-sm"
                placeholder="Describe the situation when the loss occurred..."
              ></textarea>
            </div>
          </div>

          <!-- Cause of Loss -->
          <div>
            <label for="causeOfLoss" class="block text-sm font-medium text-gray-700 mb-2">
              Cause of Loss <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <textarea
                id="causeOfLoss"
                name="cause_of_loss"
                rows="3"
                required
                class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150 ease-in-out sm:text-sm"
                placeholder="Describe what caused the damage..."
              ></textarea>
            </div>
          </div>

          <!-- Claim Details -->
          <div>
            <label for="claimDetails" class="block text-sm font-medium text-gray-700 mb-2">
              Additional Claim Details
            </label>
            <div class="relative">
              <textarea
                id="claimDetails"
                name="claim_details"
                rows="3"
                class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-150 ease-in-out sm:text-sm"
                placeholder="Any additional information about your claim..."
              ></textarea>
            </div>
            <p class="mt-1 text-xs text-gray-500">Optional: Provide any other relevant details</p>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-between pt-6 border-t border-gray-200">
          <a
            href="/dashboard"
            class="inline-flex items-center px-6 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            Cancel
          </a>
          
          <button
            type="submit"
            class="inline-flex items-center px-8 py-3 border border-transparent text-sm font-semibold rounded-lg text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 shadow-lg hover:shadow-xl transition duration-150 ease-in-out transform hover:-translate-y-0.5"
          >
            <i class="fas fa-arrow-right mr-2"></i>
            Continue to Upload Images
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Info Cards -->
  <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
      <div class="flex">
        <div class="flex-shrink-0">
          <i class="fas fa-info-circle text-blue-500 text-lg"></i>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-blue-900">Step 1 of 4</h3>
          <p class="mt-1 text-xs text-blue-700">You're filling claim information</p>
        </div>
      </div>
    </div>

    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
      <div class="flex">
        <div class="flex-shrink-0">
          <i class="fas fa-camera text-green-500 text-lg"></i>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-green-900">Next: Image Upload</h3>
          <p class="mt-1 text-xs text-green-700">AI will analyze damage photos</p>
        </div>
      </div>
    </div>

    <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-lg">
      <div class="flex">
        <div class="flex-shrink-0">
          <i class="fas fa-file-invoice-dollar text-purple-500 text-lg"></i>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-purple-900">Then: Report</h3>
          <p class="mt-1 text-xs text-purple-700">Get automated claim estimate</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  async function insurance_claims_detail() {
    const token = localStorage.getItem('token');
    try {
      const response = await fetch('/api/insurance/policies', {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });
      const data = await response.json();
      
      // Insurance code dropdown
      const insuranceCodeSelect = document.getElementById('insuranceCode');
      const userIdInput = document.getElementById('user_id');
      userIdInput.value = data.user_id;

      // Clear old options except placeholders
      insuranceCodeSelect.options.length = 1;

      // Populate dropdown
      data.insurance_policies.forEach(item => {
        const optionCode = document.createElement('option');
        optionCode.value = item.insurance_code;
        optionCode.textContent = item.insurance_code;
        insuranceCodeSelect.appendChild(optionCode);
      });
    } catch (error) {
      console.error('Failed to fetch insurance claims detail:', error);
    }
  }
  
  insurance_claims_detail();

  document.getElementById('insuranceCode').addEventListener('change', function () {
    const selectedCode = this.value;
    const policyNumberSelect = document.getElementById('policyNumber');
    policyNumberSelect.options.length = 1; // Keep placeholder only
    if (!selectedCode) return;

    fetch('/api/insurance/policy-numbers?insurance_code=' + encodeURIComponent(selectedCode))
      .then(response => response.json())
      .then(data => {
        data.policy_numbers.forEach(policyNumber => {
          const option = document.createElement('option');
          option.value = policyNumber;
          option.textContent = policyNumber;
          policyNumberSelect.appendChild(option);
        });
      })
      .catch(err => console.error('Error loading policies:', err));
  });

  // Form submission handling
  document.getElementById('insuranceClaimsForm').addEventListener('submit', function(e) {
    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalHTML = submitButton.innerHTML;
    
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    
    setTimeout(() => {
      submitButton.disabled = false;
      submitButton.innerHTML = originalHTML;
    }, 3000);
  });
</script>

{% endblock %}
